<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Quiz Engine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --gg-blue: #8ab4f8; --gg-green: #34a853; --gg-red: #ea4335;
        }
        .light {
            --bg-primary: #f8f9fa; --bg-secondary: #ffffff; --text-primary: #202124;
            --text-secondary: #5f6368; --border-color: #dadce0; --shadow-color: rgba(0,0,0,0.1);
        }
        .dark {
            --bg-primary: #1f1f1f; --bg-secondary: #2d2d2d; --text-primary: #e8eaed;
            --text-secondary: #bdc1c6; --border-color: #5f6368; --shadow-color: rgba(0,0,0,0.4);
        }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.3s, color 0.3s;
        }
        .font-googlesans { font-family: 'Google Sans', sans-serif; }
        .card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px 0 var(--shadow-color); transition: all 0.3s;
        }
        .option-btn {
            background-color: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-secondary); transition: all 0.2s ease-in-out;
        }
        .option-btn:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--gg-blue) 10%, transparent);
            border-color: var(--gg-blue); color: var(--gg-blue);
        }
        .correct { background-color: var(--gg-green) !important; border-color: var(--gg-green) !important; color: white !important; }
        .incorrect { background-color: var(--gg-red) !important; border-color: var(--gg-red) !important; color: white !important; }
        .explanation { max-height: 0; overflow: hidden; transition: all 0.5s ease-out; }
        .explanation.show { max-height: 500px; margin-top: 1.5rem; padding: 1rem; }
        #theme-toggle:checked ~ .dot { transform: translateX(1.5rem); }
        #loading-overlay { z-index: 9999; }
        #menu-sidebar.show { transform: translateX(0); }
        .history-item { cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: color-mix(in srgb, var(--gg-blue) 10%, transparent); }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-[var(--bg-primary)] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="w-16 h-16 border-4 border-t-[var(--gg-blue)] border-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-googlesans text-lg">Carregando motor do quiz...</p>
    </div>

    <div id="app-container" class="w-full max-w-3xl opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-googlesans font-bold">Quiz Engine</h1>
            <div class="flex items-center gap-4">
                <!-- Botão do Menu Hamburger -->
                <button id="menu-btn" title="Menu" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors">
                    <svg class="w-6 h-6 text-[var(--text-secondary)]" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
                    </svg>
                </button>
                <button id="history-btn" title="Ver Histórico" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors">
                    <svg class="w-6 h-6 text-[var(--text-secondary)]" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9zm-1 5v5l4.25 2.52.75-1.23-3.5-2.07V8H12z"></path>
                    </svg>
                </button>
                <label for="theme-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="theme-toggle" class="sr-only">
                        <div class="block bg-gray-300 dark:bg-gray-700 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"></div>
                    </div>
                </label>
            </div>
        </header>

        <!-- Quiz Container -->
        <div class="card rounded-2xl p-6 md:p-8 space-y-6">
            <main id="quiz-container">
                <div id="question-area" class="mb-6 min-h-[6rem] flex items-center justify-center">
                    <h2 id="question-text" class="font-googlesans text-2xl font-medium text-center"></h2>
                </div>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <div id="explanation-container" class="explanation card rounded-lg">
                    <h3 class="font-googlesans font-bold text-lg mb-2">Explicação:</h3>
                    <p id="explanation-text" class="text-secondary"></p>
                </div>
            </main>
            <footer class="flex flex-col md:flex-row items-center justify-between gap-4 pt-6 border-t border-[var(--border-color)]">
                <div id="react-root"></div>
                <div class="flex gap-4">
                    <button id="review-mode-btn" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Modo Revisão</button>
                    <button id="next-question-btn" class="w-full md:w-auto bg-[#1a73e8] hover:bg-[#185abc] text-white font-bold py-3 px-6 rounded-lg transition-colors">Pular</button>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
        <div class="card w-full max-w-4xl h-[90vh] flex flex-col rounded-2xl">
            <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)]">
                <h2 class="font-googlesans text-xl font-bold">Histórico de Atividades</h2>
                <div class="flex gap-2">
                    <select id="history-filter" class="p-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border-[var(--border-color)]">
                        <option value="all">Todas</option>
                        <option value="correct">Corretas</option>
                        <option value="incorrect">Incorretas</option>
                        <option value="skipped">Puladas</option>
                    </select>
                    <button id="clear-history-btn" class="p-2 rounded-lg bg-[var(--gg-red)] hover:bg-red-700 text-white font-bold">Limpar Histórico</button>
                    <button id="close-modal-btn" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors text-2xl">×</button>
                </div>
            </div>
            <div id="history-content" class="p-4 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div id="menu-sidebar" class="fixed top-0 left-0 h-full w-64 bg-[var(--bg-secondary)] transform -translate-x-full transition-transform duration-300 ease-in-out z-50">
        <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)]">
            <h2 class="font-googlesans text-xl font-bold">Menu</h2>
            <button id="close-menu-btn" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors text-2xl">×</button>
        </div>
        <div class="p-4">
            <a href="https://cambrero.com" target="_blank" class="block w-full bg-[#1a73e8] hover:bg-[#185abc] text-white font-bold py-3 px-4 rounded-lg text-center transition-colors mb-4">Visitar Cambrero</a>
            <button id="share-stats-btn" class="block w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-center transition-colors">Compartilhar Desempenho</button>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURAÇÃO ---
        const QUESTION_FILES = ['questoes_historia_completas_100.json'];
        const DATA_PATH = './dados/system/';

        // --- ELEMENTOS DO DOM ---
        const dom = {
            loadingOverlay: document.getElementById('loading-overlay'),
            appContainer: document.getElementById('app-container'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            explanationContainer: document.getElementById('explanation-container'),
            explanationText: document.getElementById('explanation-text'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            reviewModeBtn: document.getElementById('review-mode-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            historyBtn: document.getElementById('history-btn'),
            historyModal: document.getElementById('history-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            historyFilter: document.getElementById('history-filter'),
            historyContent: document.getElementById('history-content'),
            menuBtn: document.getElementById('menu-btn'),
            menuSidebar: document.getElementById('menu-sidebar'),
            closeMenuBtn: document.getElementById('close-menu-btn'),
            shareStatsBtn: document.getElementById('share-stats-btn'),
        };

        // --- ESTADO DA APLICAÇÃO ---
        let currentQuestion = null;
        let questionAnswered = false;
        let history = [];
        let isReviewMode = false;
        let loadedQuestions = [];

        // --- LÓGICA DE DADOS (Cookies) ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function loadHistory() {
            const savedHistory = getCookie('quizHistory');
            history = savedHistory ? JSON.parse(decodeURIComponent(savedHistory)) : [];
            updateHistoryModal(history);
            dispatchHistoryUpdate();
        }

        function saveHistory() {
            setCookie('quizHistory', encodeURIComponent(JSON.stringify(history.slice(-100))), 30); // Limita a 100 entradas
            updateHistoryModal(history);
            dispatchHistoryUpdate();
        }

        function clearHistory() {
            history = [];
            saveHistory();
        }

        function recordEvent(eventData) {
            const attempts = history.filter(h => h.questionId === eventData.questionId).length + 1;
            const record = {
                timestamp: new Date().toISOString(),
                deviceInfo: navigator.userAgent,
                questionId: eventData.questionId,
                questionText: eventData.questionText,
                status: eventData.status,
                userAnswer: eventData.userAnswer,
                correctAnswer: eventData.correctAnswer,
                attempt: attempts,
                options: eventData.options,
                explanation: eventData.explanation
            };
            history.push(record);
            saveHistory();
        }
        
        function dispatchHistoryUpdate() {
            window.dispatchEvent(new CustomEvent('historyUpdated', { detail: { history } }));
        }

        // --- LÓGICA DO QUIZ ---
        async function loadQuestions() {
            try {
                const randomFileName = QUESTION_FILES[Math.floor(Math.random() * QUESTION_FILES.length)];
                const response = await fetch(DATA_PATH + randomFileName);
                if (!response.ok) {
                    throw new Error(`Não foi possível carregar o arquivo: ${randomFileName}.`);
                }
                loadedQuestions = await response.json();
            } catch (error) {
                console.error("ERRO:", error);
                dom.questionText.textContent = `Erro ao carregar perguntas. Verifique o console (F12).`;
                dom.optionsContainer.innerHTML = '';
            }
        }

        async function loadNewQuestion() {
            if (currentQuestion && !questionAnswered) {
                recordEvent({
                    questionId: currentQuestion.índice,
                    questionText: currentQuestion.Pergunta,
                    status: 'skipped',
                    userAnswer: null,
                    correctAnswer: currentQuestion.resposta,
                    options: currentQuestion.opcoes,
                    explanation: currentQuestion.explicacao
                });
            }

            questionAnswered = false;
            if (isReviewMode) {
                const answeredQuestions = history.map(h => h.questionId);
                const availableQuestions = loadedQuestions.filter(q => answeredQuestions.includes(q.índice));
                if (availableQuestions.length === 0) {
                    dom.questionText.textContent = 'Nenhuma pergunta respondida para revisar.';
                    dom.optionsContainer.innerHTML = '';
                    return;
                }
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            } else {
                if (loadedQuestions.length === 0) await loadQuestions();
                currentQuestion = loadedQuestions[Math.floor(Math.random() * loadedQuestions.length)];
            }
            displayQuestion(currentQuestion);
        }

        function displayQuestion(q) {
            dom.questionText.textContent = q.Pergunta;
            dom.optionsContainer.innerHTML = '';
            const shuffledOptions = [...q.opcoes].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'option-btn w-full p-4 rounded-lg text-left';
                button.onclick = () => checkAnswer(button);
                dom.optionsContainer.appendChild(button);
            });
            dom.explanationText.textContent = q.explicacao;
            dom.explanationContainer.classList.remove('show');
            dom.nextQuestionBtn.textContent = isReviewMode ? 'Próxima Revisão' : 'Pular Pergunta';
            dom.reviewModeBtn.textContent = isReviewMode ? 'Sair do Modo Revisão' : 'Modo Revisão';
        }

        function checkAnswer(selectedButton) {
            if (questionAnswered) return;
            questionAnswered = true;

            const selectedAnswer = selectedButton.textContent;
            const isCorrect = selectedAnswer === currentQuestion.resposta;

            recordEvent({
                questionId: currentQuestion.índice,
                questionText: currentQuestion.Pergunta,
                status: isCorrect ? 'correct' : 'incorrect',
                userAnswer: selectedAnswer,
                correctAnswer: currentQuestion.resposta,
                options: currentQuestion.opcoes,
                explanation: currentQuestion.explicacao
            });

            dom.optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === currentQuestion.resposta) btn.classList.add('correct');
            });
            if (!isCorrect) selectedButton.classList.add('incorrect');
            
            dom.explanationContainer.classList.add('show');
            dom.nextQuestionBtn.textContent = isReviewMode ? 'Próxima Revisão' : 'Próxima Pergunta';
        }

        function loadQuestionFromHistory(questionId) {
            const historyItem = history.find(h => h.questionId === questionId && h.options && h.explanation);
            if (historyItem) {
                currentQuestion = {
                    índice: historyItem.questionId,
                    Pergunta: historyItem.questionText,
                    resposta: historyItem.correctAnswer,
                    opcoes: historyItem.options,
                    explicacao: historyItem.explanation
                };
                displayQuestion(currentQuestion);
                dom.historyModal.classList.add('hidden');
                questionAnswered = false;
            }
        }

        // --- UI & EVENTOS ---
        function updateHistoryModal(historyData, filter = 'all') {
            const filteredHistory = filter === 'all' ? historyData : historyData.filter(h => h.status === filter);
            const sortedHistory = [...filteredHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const questionAttempts = historyData.reduce((acc, h) => {
                acc[h.questionId] = (acc[h.questionId] || 0) + 1;
                return acc;
            }, {});
            
            if (sortedHistory.length === 0) {
                dom.historyContent.innerHTML = `<p class="text-center text-[var(--text-secondary)]">Nenhuma atividade registrada.</p>`;
                return;
            }
            dom.historyContent.innerHTML = sortedHistory.map(h => `
                <div class="history-item card p-4 mb-4 rounded-lg" data-question-id="${h.questionId}">
                    <p class="font-bold">${h.questionText}</p>
                    <p>Sua resposta: <span class="font-medium ${h.status === 'correct' ? 'text-[var(--gg-green)]' : h.status === 'incorrect' ? 'text-[var(--gg-red)]' : ''}">${h.userAnswer || 'Pulada'}</span></p>
                    <p class="text-sm text-[var(--text-secondary)]">Tentativa ${h.attempt} de ${questionAttempts[h.questionId]} - ${new Date(h.timestamp).toLocaleString('pt-BR')}</p>
                </div>
            `).join('');

            dom.historyContent.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const questionId = parseInt(item.getAttribute('data-question-id'));
                    loadQuestionFromHistory(questionId);
                });
            });
        }
        
        function applyTheme(isDark) {
            document.documentElement.className = isDark ? 'dark' : 'light';
        }

        function toggleMenu() {
            dom.menuSidebar.classList.toggle('show');
        }

        function toggleReviewMode() {
            isReviewMode = !isReviewMode;
            loadNewQuestion();
        }

        function shareStats() {
            const stats = history.reduce((acc, h) => {
                if (h.status === 'correct') acc.correct++;
                else if (h.status === 'incorrect') acc.incorrect++;
                else if (h.status === 'skipped') acc.skipped++;
                return acc;
            }, { correct: 0, incorrect: 0, skipped: 0 });
            const total = stats.correct + stats.incorrect + stats.skipped;
            const accuracy = total > 0 ? ((stats.correct / total) * 100).toFixed(2) : 0;
            const text = `Meu desempenho no Quiz Engine:\nCorretas: ${stats.correct}\nIncorretas: ${stats.incorrect}\nPuladas: ${stats.skipped}\nTaxa de acerto: ${accuracy}%`;
            navigator.clipboard.writeText(text).then(() => {
                alert('Desempenho copiado para a área de transferência!');
            }).catch(() => {
                alert('Erro ao copiar. Tente novamente.');
            });
        }
        
        dom.themeToggle.addEventListener('change', (e) => {
            applyTheme(e.target.checked);
            localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
        });

        dom.nextQuestionBtn.addEventListener('click', loadNewQuestion);
        dom.historyBtn.addEventListener('click', () => {
            dom.historyModal.classList.remove('hidden');
            updateHistoryModal(history, dom.historyFilter.value);
        });
        dom.closeModalBtn.addEventListener('click', () => dom.historyModal.classList.add('hidden'));
        dom.clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja limpar o histórico?')) {
                clearHistory();
            }
        });
        dom.historyFilter.addEventListener('change', (e) => {
            updateHistoryModal(history, e.target.value);
        });
        dom.menuBtn.addEventListener('click', toggleMenu);
        dom.closeMenuBtn.addEventListener('click', toggleMenu);
        dom.reviewModeBtn.addEventListener('click', toggleReviewMode);
        dom.shareStatsBtn.addEventListener('click', shareStats);

        // --- INICIALIZAÇÃO ---
        async function main() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            dom.themeToggle.checked = savedTheme === 'dark';
            applyTheme(savedTheme === 'dark');
            
            loadHistory();
            await loadNewQuestion();

            dom.loadingOverlay.style.opacity = '0';
            setTimeout(() => dom.loadingOverlay.style.display = 'none', 300);
            dom.appContainer.style.opacity = '1';
        }

        main();
    </script>
    
    <!-- React Component -->
    <script type="text/babel">
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function StatsComponent() {
            const [stats, setStats] = React.useState({ correct: 0, incorrect: 0, skipped: 0, accuracy: 0 });

            React.useEffect(() => {
                const handleHistoryUpdate = (event) => {
                    const history = event.detail.history;
                    const newStats = history.reduce((acc, h) => {
                        if (h.status === 'correct') acc.correct++;
                        else if (h.status === 'incorrect') acc.incorrect++;
                        else if (h.status === 'skipped') acc.skipped++;
                        return acc;
                    }, { correct: 0, incorrect: 0, skipped: 0 });
                    const total = newStats.correct + newStats.incorrect + newStats.skipped;
                    newStats.accuracy = total > 0 ? ((newStats.correct / total) * 100).toFixed(2) : 0;
                    setStats(newStats);
                };

                window.addEventListener('historyUpdated', handleHistoryUpdate);
                const initialHistory = JSON.parse(decodeURIComponent(getCookie('quizHistory') || '[]'));
                handleHistoryUpdate({ detail: { history: initialHistory } });

                return () => window.removeEventListener('historyUpdated', handleHistoryUpdate);
            }, []);

            return (
                <div className="text-sm text-[var(--text-secondary)]">
                    <span>Corretas: <b className="text-[var(--gg-green)]">{stats.correct}</b></span> | 
                    <span> Incorretas: <b className="text-[var(--gg-red)]">{stats.incorrect}</b></span> | 
                    <span> Puladas: <b>{stats.skipped}</b></span> | 
                    <span> Acerto: <b>{stats.accuracy}%</b></span>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('react-root')).render(<StatsComponent />);
    </script>
</body>
</html>